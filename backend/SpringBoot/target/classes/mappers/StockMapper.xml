<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
            <where>
                <if test="lastId != null">
                    s.stock_code <![CDATA[>]]> #{lastId}
                </if>
                <if test="search != null and search != ''">
                    AND (LOWER(s.name) LIKE LOWER(CONCAT(CONCAT('%', #{search}), '%')) 
                    OR LOWER(s.stock_code) LIKE LOWER(CONCAT(CONCAT('%', #{search}), '%')))
                </if>
            </where>
            ORDER BY s.stock_code
        )
        WHERE rn <![CDATA[<=]]> #{limit}

            WHERE 1=1
        ]]>
            <if test="lastId != null">
                AND s.stock_code > #{lastId}
            </if>
            <if test="search != null and search != ''">
                AND (LOWER(s.name) LIKE LOWER('%' || #{search} || '%') 
                OR LOWER(s.stock_code) LIKE LOWER('%' || #{search} || '%'))
            </if>
        <![CDATA[
            ORDER BY s.stock_code
        )
        WHERE rn <= #{limit}
        ]]>
    </select>

    <select id="getStockInfo" resultType="com.example.stock.domain.StockVO">
        SELECT * FROM (
            SELECT * FROM STOCK
            WHERE stock_code = #{stock_code}
            ORDER BY record_date DESC
        ) WHERE ROWNUM = 1
    </select>

    <select id="getStockPriceHistory" resultType="com.example.stock.domain.StockVO">
        SELECT * FROM STOCK
        WHERE stock_code = #{stock_code}
        <choose>
            <when test="range == '1D'">
                AND record_date >= SYSDATE - 1
            </when>
            <when test="range == '1W'">
                AND record_date >= SYSDATE - 7
            </when>
            <when test="range == '1M'">
                AND record_date >= ADD_MONTHS(SYSDATE, -1)
            </when>
            <when test="range == '1Y'">
                AND record_date >= ADD_MONTHS(SYSDATE, -12)
            </when>
        </choose>
        ORDER BY record_date ASC
    </select>
    
      <select id="getYearlyStockPriceHistory" resultType="com.example.stock.domain.StockVO">
        SELECT * FROM STOCK
        WHERE stock_code = #{stock_code}
        AND record_date >= ADD_MONTHS(SYSDATE, -12)
        ORDER BY record_date ASC
    </select>
</mapper>
