<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.example.mgr.dao.MgrDAO">

   <!-- session 생성 시 데이터 저장(방문자 데이터 ) -->
   <insert id="saveSession" parameterType="MgrSessionCountVO">
      INSERT INTO countVisit(sessionId, creationTime)
      VALUES(#{sessionId}, TRUNC(SYSDATE))
   </insert>
   
   <!-- 총 방문자 수 -->
   <select id="selectTotalSession" parameterType="MgrSessionCountVO" resultType="int">
      SELECT count(*)
      FROM countVisit
   </select>
   
   <!-- 오늘 방문자 수 -->
   <select id="selectTodaySession" parameterType="MgrSessionCountVO" resultType="int">
      SELECT count(*)
      FROM countVisit
      WHERE TRUNC(creationTime) = TRUNC(SYSDATE)
   </select>
   
   <!-- 한 달 방문자 수 -->
   <select id="selectMonthSession" parameterType="MgrSessionCountVO" resultType="int">
      SELECT count(*)
      FROM countVisit
      WHERE creationTime BETWEEN ADD_MONTHS(TRUNC(SYSDATE), -1) AND TRUNC(SYSDATE)
   </select>
   
   <!-- 회원 수 -->
   <select id="selectTotalMembers" parameterType="MgrMemberVO" resultType="int">
      SELECT count(*)
      FROM users
   </select>
   
   <!-- 금일 회원가입 수 -->
   <select id="selectTodayMembers" parameterType="MgrMemberVO" resultType="int">
      SELECT count(*)
      FROM users
      WHERE TRUNC(created_at) = TRUNC(SYSDATE)
   </select>
   
   <!-- 최근 5일간 가입자 수  -->
   <select id="selectLast5DaysMember" parameterType="MgrMemberVO" resultType="Map">
   <![CDATA[
      WITH date_range AS (
      SELECT TRUNC(SYSDATE) - 4 + LEVEL - 1 AS join_date
      FROM DUAL
      CONNECT BY LEVEL <= 5)
      SELECT TO_CHAR(dr.join_date, 'YYYY-MM-DD') AS join_date, NVL(COUNT(u.created_at), 0) AS join_count
      FROM date_range dr
      LEFT JOIN users u ON TO_CHAR(u.created_at, 'YYYY-MM-DD') = TO_CHAR(dr.join_date, 'YYYY-MM-DD')
      GROUP BY TO_CHAR(dr.join_date, 'YYYY-MM-DD')
      ORDER BY join_date
   ]]>
   </select>
   
   <!-- 최근 5달간 가입자 수       AND TRUNC(SYSDATE) > created_at -->
   <select id="selectLast5MonthsMember" parameterType="MgrMemberVO" resultType="Map">
      SELECT TO_CHAR(created_at, 'YYYY-MM') AS join_month, COUNT(*) AS join_count
      FROM users
      WHERE created_at >= ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -4)
      GROUP BY TO_CHAR(created_at, 'YYYY-MM')
      ORDER BY join_month
   </select>
   
   <!-- 최근 2년간 가입자 수 -->
   <select id="selectLast2YearsMember" parameterType="MgrMemberVO" resultType="Map">
      SELECT TO_CHAR(created_at, 'YYYY') AS join_year, COUNT(*) AS join_count
      FROM users
      WHERE created_at >= ADD_MONTHS(TRUNC(SYSDATE, 'YYYY'), -24)
      GROUP BY TO_CHAR(created_at, 'YYYY')
      ORDER BY join_year
   </select>
   
   <!-- 구독자 수 -->
   <select id="selectTotalSubscribers" parameterType="MgrSubscriberCountVO" resultType="int">
      SELECT count(*)
      FROM subscribe
   </select>
   
   <!-- 금일 구독자 수 -->
   <select id="selectTodaySubscribers" parameterType="MgrSubscriberCountVO" resultType="int">
      SELECT count(*)
      FROM subscribe
      WHERE TRUNC(payment_date) = TRUNC(SYSDATE)
   </select>
   
   <!-- 회원 연령대 -->
    <select id="countByAgeMember" resultType="map">
      SELECT 
        age_group,
        COUNT(*) AS count
      FROM (
        SELECT 
            CASE
                WHEN age BETWEEN 10 AND 19 THEN '10대'
                WHEN age BETWEEN 20 AND 29 THEN '20대'
                WHEN age BETWEEN 30 AND 39 THEN '30대'
                WHEN age BETWEEN 40 AND 49 THEN '40대'
                WHEN age >= 50 THEN '50대 이상'
                ELSE '구글 회원'
            END AS age_group
      FROM (
            SELECT 
                FLOOR((SYSDATE - TO_DATE(user_birthdate, 'RRMMDD')) / 365) AS age
            FROM users
        ) derived_table
      ) age_groups
      GROUP BY age_group
    </select>
    
    <!-- 회원 목록 리스트 출력 -->
    <select id="selectMembers" resultType="MgrMemberVO">
    	SELECT *
    	FROM users
    	ORDER BY user_num DESC
    </select>
    
    <!-- memberDetail 출력(회원상세보기) / 구독테이블도 같이 -->
    <select id="selectMemberDetail" resultType="MgrMemberVO">
    	SELECT *
    	FROM users
    	WHERE user_num = #{user_num}
    </select>
    <!-- 
    <select id="selectMemberDetail" resultType="MgrMemberVOMap">
    	SELECT u.*, s.*
    	FROM users u
    	LEFT JOIN subscribe s ON u.user_num = s.user_num
    	WHERE u.user_num = #{user_num}
    </select>
     -->
    
    <!-- 회원 삭제 -->
    <delete id="deleteMember" parameterType="int">
    	DELETE FROM users
    	WHERE user_num = #{user_num}
    </delete>
    
    <!-- 회원 수정 -->
    <update id="updateMember" parameterType="MgrMemberVO">
    	UPDATE users
    	SET user_name = #{user_name},
    		user_nickname = #{user_nickname},
    		user_id = #{user_id},
    		user_tel = #{user_tel},
    		user_email = #{user_email}
    	WHERE user_num = #{user_num}
    </update>
    
    <!-- memberDetail 커뮤니티 글 출력  -->
    <select id="selectCommPost" resultType="MgrCommunityVO">
    	SELECT *
    	FROM community
    	WHERE user_num = #{user_num}
    </select>
    
    <!-- 커뮤니티 관리 -->
    <select id="selectCommPostAll" resultType="MgrCommunityVO">
    	SELECT c.*, u.user_name
    	FROM community c
    	JOIN users u ON c.user_num = u.user_num
    	ORDER BY c.id DESC
    </select>
    
    <!-- 커뮤니티 글 카운팅 -->
    <select id="selectCommCount" parameterType="MgrCommunityVO" resultType="int">
    	SELECT count(*)
    	FROM community
    </select>
    
    <!-- 매니저 여부 확인 -->
    <select id="checkManager" parameterType="MgrManagerVO" resultType="int">
    	SELECT count(*)
    	FROM manager
    	WHERE manager_num = #{manager_num}
    </select>
    
    <!-- 매니저로 체크 될 때 insert문 -->
    <insert id="insertManager" parameterType="MgrManagerVO">
    	INSERT INTO manager (manager_num, manager_name)
    	SELECT #{manager_num}, user_name
    	FROM users
    	WHERE user_num = #{manager_num}
    </insert>
    
    <!-- 관리자 체크박스 풀고 수정 했을 때 delete문 -->
    <delete id="deleteManager" parameterType="int">
    	DELETE FROM manager
    	WHERE manager_num = #{manager_num}
    </delete>
    
    
</mapper>

